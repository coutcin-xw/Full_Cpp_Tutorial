# 6.3 字符串处理

> 深入理解std::string和正则表达式，掌握文本处理技巧

## 目录

- [string类详解](#string类详解)
- [字符串查找与替换](#字符串查找与替换)
- [字符串与数值转换](#字符串与数值转换)
- [正则表达式（C++11）](#正则表达式c11)
- [字符串视图（C++17）](#字符串视图c17)
- [本节小结](#本节小结)

---

## string类详解

### string基础操作

`std::string`是C++标准库提供的字符串类，封装了字符数组的操作。

```cpp
#include <string>
#include <iostream>

void stringBasic() {
    // 创建string
    std::string s1;                      // 空
    std::string s2 = "hello";           // 初始化
    std::string s3(10, 'x');            // 10个'x'
    std::string s4(s2);                  // 拷贝
    std::string s5(s2, 1, 3);           // "ell" (从位置1开始，3个字符)
    std::string s6("world", 2);          // "wo" (前2个字符)

    // 赋值
    s1 = "Hello";
    s2 = s1;

    // 拼接
    s1 += " World";
    s1.append("!");

    // 大小和容量
    size_t len = s1.length();           // 长度
    size_t sz = s1.size();              // 同length()
    size_t cap = s1.capacity();         // 容量
    bool empty = s1.empty();            // 是否为空

    // 访问字符
    char c = s1[0];           // 下标访问（不检查边界）
    c = s1.at(0);             // 带边界检查
    c = s1.front();          // 第一个字符
    c = s1.back();           // 最后一个字符

    // 遍历
    for (char ch : s1) {
        std::cout << ch;
    }
}
```

### string修改操作

```cpp
void stringModify() {
    std::string s = "Hello";

    // 调整大小
    s.resize(10);          // 调整大小，填充'\0'
    s.resize(20, 'x');     // 调整大小，填充'x'
    s.reserve(100);        // 预留容量

    // 清空
    s.clear();             // 清空内容
    s.shrink_to_fit();    // 收缩容量到size

    // 添加字符
    s = "Hello";
    s.push_back('!');     // 尾部添加
    s += " World";        // 追加
    s.append(3, '!');     // 追加3个'!'

    // 插入
    s.insert(5, " there");

    // 删除
    s.erase(5, 6);        // 从位置5删除6个字符
    s.pop_back();         // 删除最后一个字符

    // 替换
    s.replace(0, 5, "Hi"); // 替换0-5为"Hi"

    // 交换
    std::string s2 = "World";
    s.swap(s2);           // 交换内容（O(1)）
}
```

---

## 字符串查找与替换

### 查找操作

```cpp
void stringFind() {
    std::string s = "Hello World! Hello C++!";

    // find：查找子串首次出现
    size_t pos = s.find("Hello");           // 0
    pos = s.find("Hello", 1);               // 13 (从位置1开始)
    if (pos == std::string::npos) {
        std::cout << "Not found\n";
    }

    // rfind：从后查找
    pos = s.rfind("Hello");                 // 13

    // find_first_of：查找任一字符
    pos = s.find_first_of("aeiou");         // 1 ('e')

    // find_last_of：从后查找任一字符
    pos = s.find_last_of("aeiou");          // 21 ('o')

    // find_first_not_of：查找不在集合中的字符
    pos = s.find_first_not_of("Hello ");    // 5 ('W')

    // find_last_not_of：从后查找不在集合中的字符
    pos = s.find_last_not_of(" !+C");       // 20 ('o')

    // 子串
    std::string sub = s.substr(0, 5);        // "Hello"
    sub = s.substr(6);                      // "World! Hello C++!"

    // 比较子串
    int cmp = s.compare(0, 5, "Hello");      // 0 (相等)
}
```

### 替换操作

```cpp
void stringReplace() {
    std::string s = "Hello World";

    // 替换指定范围
    s.replace(6, 5, "C++");                 // "Hello C++"

    // 全部替换某个字符
    std::string s2 = "aaa";
    size_t pos = 0;
    while ((pos = s2.find('a')) != std::string::npos) {
        s2.replace(pos, 1, "b");
    }
    // s2: "bbb"

    // 更高效的方式：使用算法
    s2 = "aaa";
    std::replace(s2.begin(), s2.end(), 'a', 'b');

    // 删除所有空格
    std::string s3 = "a b c d e";
    s3.erase(std::remove(s3.begin(), s3.end(), ' '),
            s3.end());
    // s3: "abcde"
}
```

---

## 字符串与数值转换

### C++11转换函数

```cpp
#include <string>

void stringNumberConversion() {
    // string转数值
    std::string str_num = "42";
    int i = std::stoi(str_num);                // 42
    long l = std::stol(str_num);               // 42L
    long long ll = std::stoll("1234567890");   // 1234567890LL

    double d = std::stod("3.14159");           // 3.14159
    float f = std::stof("2.71f");              // 2.71f

    // 数值转string
    std::string s1 = std::to_string(42);       // "42"
    std::string s2 = std::to_string(3.14);     // "3.140000"
    std::string s3 = std::to_string(0xFF);     // "255"

    // 指定进制转换
    i = std::stoi("FF", nullptr, 16);           // 255 (十六进制)
    i = std::stoi("77", nullptr, 8);            // 63 (八进制)
}
```

### 使用stringstream

```cpp
#include <sstream>

void stringstreamConversion() {
    // 任意类型转string
    std::ostringstream oss;
    oss << "Value: " << 42 << ", Pi: " << 3.14;
    std::string result = oss.str();

    // string转任意类型
    std::string data = "10 20 3.14";
    std::istringstream iss(data);

    int a, b;
    double c;
    iss >> a >> b >> c;

    // 更灵活的解析
    std::string line = "name=John age=30";
    std::istringstream iss2(line);
    std::string key, value;
    char ch;
    while (iss2 >> key >> ch >> value) {
        std::cout << key << ": " << value << "\n";
    }
}
```

### C风格转换（不推荐）

```cpp
void cStyleConversion() {
    char str[] = "12345";
    int i = std::atoi(str);          // 12345 (失败返回0)

    char buffer[100];
    std::sprintf(buffer, "%d", 42);  // "42"

    // 注意：C风格转换不检查错误，应优先使用C++方法
}
```

---

## 正则表达式（C++11）

### regex基础

C++11引入了`<regex>`库，提供强大的正则表达式支持。

```cpp
#include <regex>
#include <iostream>

void regexBasic() {
    // 基本匹配
    std::string text = "Hello World";
    std::pattern pat("Hello");     // C++26将使用std::pattern
    // 当前使用std::regex
    std::regex pattern("Hello");

    bool matched = std::regex_match(text, pattern);
    std::cout << "Match: " << matched << "\n";

    // 搜索子串
    pattern = "World";
    bool found = std::regex_search(text, pattern);
    std::cout << "Found: " << found << "\n";

    // 正则表达式选项
    std::regex case_insensitive("hello",
                               std::regex_constants::icase);
    matched = std::regex_match(text, case_insensitive);
}
```

### regex_match

```cpp
void regexMatchDemo() {
    std::regex email_pattern(
        R"([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})"
    );

    std::string email1 = "user@example.com";
    std::string email2 = "invalid.email";

    bool valid1 = std::regex_match(email1, email_pattern);
    bool valid2 = std::regex_match(email2, email_pattern);

    std::cout << email1 << " is " << (valid1 ? "valid" : "invalid") << "\n";
    std::cout << email2 << " is " << (valid2 ? "valid" : "invalid") << "\n";
}
```

### regex_search

```cpp
void regexSearchDemo() {
    std::string text = "The price is $123.45, discount is 15%";

    // 查找数字
    std::regex num_pattern(R"(\d+\.\d+)");
    std::smatch match;

    if (std::regex_search(text, match, num_pattern)) {
        std::cout << "Found: " << match.str() << "\n";  // 123.45
        std::cout << "Position: " << match.position() << "\n";
    }

    // 查找所有匹配
    std::regex digit_pattern(R"(\d+)");
    std::sregex_iterator it(text.begin(), text.end(), digit_pattern);
    std::sregex_iterator end;

    while (it != end) {
        std::smatch m = *it;
        std::cout << "Found: " << m.str() << "\n";
        ++it;
    }
}
```

### regex_replace

```cpp
void regexReplaceDemo() {
    std::string text = "Hello World! Welcome to C++ World!";

    // 简单替换
    std::regex pattern("World");
    std::string result = std::regex_replace(text, pattern, "Universe");
    std::cout << result << "\n";

    // 使用捕获组
    std::regex date_pattern(R"((\d{4})-(\d{2})-(\d{2}))");
    std::string date = "2024-01-15";

    // 重新排列日期格式
    result = std::regex_replace(date, date_pattern, R"($3/$2/$1)");
    std::cout << result << "\n";  // "15/01/2024"

    // 使用回调函数进行替换
    std::string text2 = "Price: $100, Tax: $20";
    std::regex price_pattern(R"(\$(\d+))");

    result = std::regex_replace(text2, price_pattern,
        [](const std::smatch& m) {
            int price = std::stoi(m.str().substr(1));
            price = static_cast<int>(price * 1.1); // 加10%
            return "$" + std::to_string(price);
        });
    std::cout << result << "\n";
}
```

### 常用正则表达式模式

```cpp
void commonPatterns() {
    // 邮箱验证
    std::regex email(
        R"([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})"
    );

    // 电话号码
    std::regex phone(
        R"(\d{3}-\d{3}-\d{4}|\(\d{3}\)\s*\d{3}-\d{4})"
    );

    // URL
    std::regex url(
        R"(https?://[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(/[^\s]*)?)"
    );

    // IP地址
    std::regex ip(
        R"((\d{1,3}\.){3}\d{1,3})"
    );

    // 日期（YYYY-MM-DD）
    std::regex date(
        R"(\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))"
    );

    // 用户名（字母开头，4-16位字母数字下划线）
    std::regex username(
        R"([a-zA-Z][a-zA-Z0-9_]{3,15})"
    );

    // 十六进制颜色
    std::regex hex_color(
        R"(#[0-9a-fA-F]{6})"
    );
}
```

---

## 字符串视图（C++17）

### string_view基础

`std::string_view`提供对字符串序列的非拥有引用视图，避免不必要的拷贝。

```cpp
#include <string_view>

void stringViewBasic() {
    std::string str = "Hello, World!";

    // 创建string_view
    std::string_view sv = str;
    std::string_view sv2 = "Literal";       // 字符串字面量
    std::string_view sv3(str, 0, 5);        // "Hello"

    // 避免拷贝
    void printString(std::string_view sv);
    printString(str);                        // 无拷贝
    printString("Temporary");                // 无拷贝

    // 子串视图（无拷贝）
    std::string_view sub = sv.substr(0, 5);
}
```

### string_view操作

```cpp
void stringViewOperations() {
    std::string_view sv = "Hello, World!";

    // 大小
    size_t len = sv.length();
    size_t sz = sv.size();
    bool empty = sv.empty();

    // 访问字符
    char c = sv[0];
    c = sv.at(0);
    c = sv.front();
    c = sv.back();

    // 移除前缀/后缀（C++17）
    sv.remove_prefix(7);   // 移除"Hello, "
    // sv: "World!"

    sv.remove_suffix(1);   // 移除"!"
    // sv: "World"

    // 比较和查找
    int cmp = sv.compare("World");
    size_t pos = sv.find("or");

    // 转换为string
    std::string s = sv;   // 显式转换
}
```

### string_view注意事项

```cpp
void stringViewGotchas() {
    // ⚠️ 生命周期问题
    std::string_view sv;

    {
        std::string temp = "Temporary";
        sv = temp;
    } // temp被销毁

    // std::cout << sv << "\n"; // 未定义行为！悬垂引用

    // ✅ 正确做法
    std::string str = "Persistent";
    sv = str;
    // str在使用期间保持有效

    // ⚠️ 修改原始字符串
    str = "Hello";
    sv = str;
    str = "World";  // sv可能失效
}
```

---

## 本节小结

### 知识点回顾

1. **string类**：
   - 基本操作：创建、访问、修改
   - 查找：find, rfind, find_first_of等
   - 修改：replace, erase, insert等
   - 数值转换：sto系列、to_string

2. **正则表达式**：
   - regex_match：完全匹配
   - regex_search：部分匹配
   - regex_replace：替换
   - 捕获组和回调

3. **string_view**：
   - 非拥有视图
   - 避免拷贝
   - 注意生命周期

### 最佳实践

```cpp
// ✅ 推荐做法
std::string s = "hello";
void func(std::string_view sv); // 避免拷贝

// 验证输入
std::regex email_pattern(R"(...)");
if (std::regex_match(email, email_pattern)) {
    // 有效邮箱
}

// ❌ 避免
char* str = "hello";           // 使用string
sprintf(buf, "%s", s.c_str()); // 使用string或format
```

### 学习建议

1. **优先使用string**：而不是C风格字符串
2. **理解正则表达式**：功能强大但注意性能
3. **善用string_view**：减少不必要的拷贝
4. **注意编码**：C++默认使用UTF-8或本地编码
5. **测试边界情况**：空字符串、极端情况

### 练习

1. 实现一个简单的CSV解析器
2. 编写函数验证手机号、邮箱格式
3. 使用正则表达式提取HTML标签中的内容
4. 实现split函数，将字符串按分隔符分割

---

**下一节：6.4-输入输出流** - 深入理解C++的I/O系统
